# kubernetes Event Scale Controller

### Getting started:

I'm following this https://blog.openshift.com/kubernetes-deep-dive-code-generation-customresources/. There is also `k8s.io/sample-controller` project which contains most of the boilerplate code in this repo.

1. Clone the project

```bash
cd $GOPATH/src
mkdir -p github.com/Azure/Kore
git clone https://github.com/Azure/Kore github.com/Azure/Kore
```

2. Get all the dependencies

```bash
go get k8s.io/client-go/...
go get k8s.io/apimachinery/...
go get k8s.io/code-generator/...
```

3. Files under `pkg/client` as well as `pkg/apis/kesc/v1alpha1/zz_generated.deepcopy.go` are autogenerated client libraries based on the other files under `pkg/apis`. `pkg/signals` is copied from `k8s.io/sample-client/pkg/signals`

4. To generate the client, you can run `hack/generate-groups.sh`. Make sure `GOPATH` is defined.

5. Deploy `ScaledObject` CRD to your cluster

```bash
kubectl create -f crd/scaledobject-crd.yaml
```

6. Deploy a functions pod with a service using

```bash
kubectl create -f crd/functions-deployment.yaml

# check deployment
kubectl get deployments
```

The sample deployment above deploys `mcr.microsoft.com/azure-functions/dotnet:2.0` image which is a vanilla empty functions image.

The replica count should be 0 for that deployment by default. 

7. Deploy a `ScaledObject` that reference that deployment by name

```bash
kubectl create -f crd/example-scaledobject-crd.yaml
```

8. Run the scale controller

```bash
go run *.go --kubeconfig=/home/ahmed/.kube/config
# OR 
go run *.go --kubeconfig=C:\Users\ahmels\.kube\config
```

The scale controller is watching for ScaledObjects and Deployments. If there is a ScaledObject, it gets its associated deployment and updates its replicas from 0 to 1.

9. You can controll the replica set for your deployment using `kubectl` and see the controller scaling it back to 1.

```bash
kubectl scale --replicas=0 deployment/azure-functions-deployment
```

![k](https://user-images.githubusercontent.com/645740/51940231-46cf5380-23c6-11e9-9433-39cdd4055b4c.gif)