on:
  workflow_call:

jobs:
  validate-upgrade-build:
    name: Image generation
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Build and export (operator)
      uses: docker/build-push-action@v2
      with:
        context: .
        file: Dockerfile
        tags: ghcr.io/kedacore/keda:main
        outputs: type=docker,dest=/tmp/operator.tar
    
    - name: Build and export (metrics-server)
      uses: docker/build-push-action@v2
      with:
        context: .
        file: Dockerfile.adapter
        tags: ghcr.io/kedacore/keda-metrics-apiserver:main
        outputs: type=docker,dest=/tmp/metrics-server.tar

    - name: Upload artifact (operator)
      uses: actions/upload-artifact@v2
      with:
        name: operator
        path: /tmp/operator.tar
    
    - name: Upload artifact (metrics-server)
      uses: actions/upload-artifact@v2
      with:
        name: metrics-server
        path: /tmp/metrics-server.tar

  validate-upgrade:
    needs: validate-upgrade-build
    name: ${{ matrix.kubernetesVersion }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        kubernetesVersion: [v1.23, v1.22, v1.21, v1.20, v1.19, v1.18, v1.17]
        include:
          # Images are defined on every Kind release
          # See https://github.com/kubernetes-sigs/kind/releases
        - kubernetesVersion: v1.23
          kindImage: kindest/node:v1.23.0@sha256:49824ab1727c04e56a21a5d8372a402fcd32ea51ac96a2706a12af38934f81ac
        - kubernetesVersion: v1.22
          kindImage: kindest/node:v1.22.0@sha256:b8bda84bb3a190e6e028b1760d277454a72267a5454b57db34437c34a588d047
        - kubernetesVersion: v1.21
          kindImage: kindest/node:v1.21.1@sha256:69860bda5563ac81e3c0057d654b5253219618a22ec3a346306239bba8cfa1a6
        - kubernetesVersion: v1.20
          kindImage: kindest/node:v1.20.7@sha256:cbeaf907fc78ac97ce7b625e4bf0de16e3ea725daf6b04f930bd14c67c671ff9
        - kubernetesVersion: v1.19
          kindImage: kindest/node:v1.19.11@sha256:07db187ae84b4b7de440a73886f008cf903fcf5764ba8106a9fd5243d6f32729
        - kubernetesVersion: v1.18
          kindImage: kindest/node:v1.18.19@sha256:7af1492e19b3192a79f606e43c35fb741e520d195f96399284515f077b3b622c
        - kubernetesVersion: v1.17
          kindImage: kindest/node:v1.17.17@sha256:66f1d0d91a88b8a001811e2f1054af60eef3b669a9a74f9b6db871f2f1eeed00

    steps:
    - name: Check out code
      uses: actions/checkout@v2
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Download artifact (operator)
      uses: actions/download-artifact@v2
      with:
        name: operator
        path: /tmp

    - name: Download artifact (metrics-server)
      uses: actions/download-artifact@v2
      with:
        name: metrics-server
        path: /tmp
    
    - name: Load image
      run: |
        docker load --input /tmp/operator.tar
        docker load --input /tmp/metrics-server.tar
        docker image ls -a

    - name: Setup go
      uses: actions/setup-go@v2
      with:
        go-version: 1.17

    - name: Helm install
      uses: Azure/setup-helm@v1
      
    - name: Create k8s ${{ matrix.kubernetesVersion }} Kind Cluster
      uses: helm/kind-action@v1.2.0
      with:
        node_image: ${{ matrix.kindImage }}

    - name: Show versions
      run: |
        echo "kubectl version:"
        kubectl version
        echo "helm version:"
        helm version

    - name: Install latest KEDA release
      run: |
        helm repo add kedacore https://kedacore.github.io/charts
        helm repo update
        helm install keda kedacore/keda --namespace keda --create-namespace --wait

    - name: Deploy workloads
      run: kubectl apply -f .github/assets/test-upgrade-manifest.yml

    - name: Deploy current version
      run : make deploy

    - name: Redeploy workloads
      run: kubectl apply -f .github/assets/test-upgrade-manifest.yml

    - name: Clean resources
      run: kubectl delete -f .github/assets/test-upgrade-manifest.yml 
      if: always()
