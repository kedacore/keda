name: debug
on:
  - pull_request

env:
  E2E_CHECK_NAME: e2e tests

jobs:
  run-test:
    runs-on: equinix-keda-runner
    name: Execute e2e tests
    container: ghcr.io/kedacore/keda-tools:1.21.9
    steps:
      - name: Check out code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
        with:
          fetch-depth: 1
  
      - uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}

      - name: Run end to end tests
        continue-on-error: true
        id: code
        env:
          AWS_RUN_IDENTITY_TESTS: true
          AZURE_RUN_WORKLOAD_IDENTITY_TESTS: true
          GCP_RUN_IDENTITY_TESTS: true
          ENABLE_OPENTELEMETRY: true
          TEST_CLUSTER_NAME: keda-e2e-cluster-pr
        run: |
          make get-cluster-context

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false

      - name: Run end to end tests
        continue-on-error: true
        id: test
        env:
          AWS_RUN_IDENTITY_TESTS: true
          AZURE_RUN_WORKLOAD_IDENTITY_TESTS: true
          GCP_RUN_IDENTITY_TESTS: true
          ENABLE_OPENTELEMETRY: true
          TEST_CLUSTER_NAME: keda-e2e-cluster-pr
        run: |
          make e2e-test
      
